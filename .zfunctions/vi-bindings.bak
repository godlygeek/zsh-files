bindkey -v

function show_mode {
  #print -Pn "%{\e7\e[\e[${COLUMNS}G \e[K%}-- $1 --%{\e8\e[B\e[A%}"
  POSTDISPLAY=$'\n'"-- $1 --"
}

function my-accept-line {
  POSTDISPLAY=""
  #zle .redisplay
  zle .accept-line
}
zle -N my-accept-line
bindkey "^M" my-accept-line

#function show_mode {
#  #zle -M -- "-- $1 --" &>/dev/null
# 
#  #print -Pn "\e7${(l:$((COLUMNS-1)):::):-}\e[2K-- $1 --\e8\e[B\e[A"
#
#  #if [[ $BUFFERLINES -le 1 ]]; then
#  #  print -n "\e7\e[${COLUMNS}G \e[K-- $1 --\e8\e[B\e[A"
#  #fi
#
#  POSTDISPLAY=$'\n'"-- $1 --"
#}

#function zle-line-init {
#  if [[ $CONTEXT == start ]]; then
#    print -Pn "%{\e7\e[${COLUMNS}G \e[K%}-- INSERT --%{\e8\e[B\e[A%}"
#  fi
#}
#zle -N zle-line-init

setopt prompt_subst;
PS1=$'%{\e7\e[${COLUMNS}G \e[K-- INSERT --\e8\e[B\e[A%}'"$PS1"
PS2=$'%{\e7\e[${COLUMNS}G \e[K-- INSERT --\e8\e[B\e[A%}'"$PS2"
PS3=$'%{\e7\e[${COLUMNS}G \e[K-- INSERT --\e8\e[B\e[A%}'"$PS3"
PS4=$'%{\e7\e[${COLUMNS}G \e[K-- INSERT --\e8\e[B\e[A%}'"$PS4"

#function zle-line-init {
#  #POSTDISPLAY=$'\n'"-- INSERT --"
#  #print -Pn "%{\e7\e[${COLUMNS}G \e[K%}-- INSERT --%{\e8\e[B\e[A%}"
#  #show_mode INSERT
#  POSTDISPLAY=$'\n'"-- INSERT --"
#}
#zle -N zle-line-init

#PS2=$'%{\e[1G\e[K%}'"$PS2"

# Maybe one day this will be supported well enough...
function zle-keymap-select {
  if [[ "$KEYMAP" == vicmd ]]; then
    #POSTDISPLAY=$'\n'"-- NORMAL --"
    show_mode NORMAL
  else
    #POSTDISPLAY=$'\n'"-- INSERT --"
    show_mode INSERT
  fi
  #if [[ $BUFFERLINES -le 1 ]]; then
  #  local map="INSERT";
  #  [[ "$KEYMAP" = vicmd ]] && map="NORMAL"
  #  print -Pn "\e7\e[${COLUMNS}G \e[K-- $map --\e8\e[B\e[A"
  #fi
}
zle -N zle-keymap-select

##precmd() { show_mode INSERT }
#
#function my-vi-add-eol {
#  zle .vi-add-eol
#  show_mode INSERT
#}
#zle -N my-vi-add-eol 
#bindkey -M vicmd -- "A" my-vi-add-eol 
#
#function my-vi-add-next {
#  zle .vi-add-next
#  show_mode INSERT
#}
#zle -N my-vi-add-next 
#bindkey -M vicmd -- "a" my-vi-add-next 
#
#function my-vi-change-eol {
#  zle .vi-change-eol
#  show_mode INSERT
#}
#zle -N my-vi-change-eol 
#bindkey -M vicmd -- "C" my-vi-change-eol 
#
#function my-vi-change-whole-line {
#  zle .vi-change-whole-line
#  show_mode INSERT
#}
#zle -N my-vi-change-whole-line 
#bindkey -M vicmd -- "S" my-vi-change-whole-line 
#
## Takes a movement command
#function my-vi-change {
#  show_mode INSERT
#  zle .vi-change
#}
#zle -N my-vi-change
#bindkey -M vicmd -- "c" my-vi-change
#
#function my-vi-insert {
#  zle .vi-insert
#  show_mode INSERT
#}
#zle -N my-vi-insert 
#bindkey -M vicmd -- "i" my-vi-insert 
#
#function my-vi-insert-bol {
#  zle .vi-insert-bol
#  show_mode INSERT
#}
#zle -N my-vi-insert-bol 
#bindkey -M vicmd -- "I" my-vi-insert-bol 
#
#function my-vi-open-line-above {
#  zle .vi-open-line-above
#  show_mode INSERT
#}
#zle -N my-vi-open-line-above 
#bindkey -M vicmd -- "O" my-vi-open-line-above 
#
#function my-vi-open-line-below {
#  zle .vi-open-line-below
#  show_mode INSERT
#}
#zle -N my-vi-open-line-below 
#bindkey -M vicmd -- "o" my-vi-open-line-below 
#
#function my-vi-replace {
#  zle .vi-replace
#  show_mode REPLACE
#}
#zle -N my-vi-replace 
#bindkey -M vicmd -- "R" my-vi-replace 
#
#function my-vi-cmd-mode {
#  zle .vi-cmd-mode
#  show_mode NORMAL
#}
#zle -N my-vi-cmd-mode 
#bindkey -M viins -- "^[" my-vi-cmd-mode 
